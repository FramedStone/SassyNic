name: PR Lint Check

on:
  pull_request:
    types: [opened, reopened, synchronize]
    branches: [main, develop]

jobs:
  lint-checks:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout PR branch
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Fetch base branch for comparison
        run: |
          git fetch origin ${{ github.event.pull_request.base.ref }}:refs/remotes/origin/${{ github.event.pull_request.base.ref }}

      - name: Compare manifest.json versions
        run: |
          compare_manifest_version() {
            local dir="$1"
            local path="$dir/manifest.json"

            if [ ! -f "$path" ]; then
              echo "‚ö†Ô∏è  $path not found, skipping..."
              return
            fi

            echo "üîç Checking $path"

            # Extract versions
            newVersion=$(jq -r '.version' "$path" 2>/dev/null)
            baseVersion=$(git show "origin/${{ github.event.pull_request.base.ref }}:$path" 2>/dev/null | jq -r '.version' 2>/dev/null || echo "0.0.0")

            echo "Base version: $baseVersion"
            echo "New version:  $newVersion"

            if [ "$baseVersion" = "0.0.0" ]; then
              echo "‚ùå  No manifest.json found for $dir."
              exit 1
            fi

            # Compare semver using sort -V
            if [ "$(printf '%s\n' "$baseVersion" "$newVersion" | sort -V | tail -n1)" = "$newVersion" ] && [ "$baseVersion" != "$newVersion" ]; then
              echo "‚úÖ $path version is greater than base branch."
              elif [ "$baseVersion" = "$newVersion" ]; then
                echo "‚ùå $path version not updated."
                echo "::warning::$path version not updated."
                exit 1
              else
                echo "‚ùå $path version decreased."
                exit 1
            fi
          }

          # Determine affected directories based on changed files
          dirs_to_check=()
          if git diff --name-only "origin/${{ github.event.pull_request.base.ref }}" | grep -q "^SassyNic-Student/"; then
            dirs_to_check+=("SassyNic-Student")
          fi
          if git diff --name-only "origin/${{ github.event.pull_request.base.ref }}" | grep -q "^SassyNic-Universal/"; then
            dirs_to_check+=("SassyNic-Universal")
          fi

          if [ ${#dirs_to_check[@]} -eq 0 ]; then
            echo "‚ÑπÔ∏è  No changes detected in SassyNic-Student or SassyNic-Universal directories. Skipping manifest version checks."
          else
            for dir in "${dirs_to_check[@]}"; do
              compare_manifest_version "$dir"
            done
          fi

      - name: Check SECURITY.md changes
        run: |
          if [ ! -f "SECURITY.md" ]; then
            echo "‚ùå SECURITY.md is missing!"
            exit 1
          fi

          # Compare SECURITY.md content with base branch
          git show "origin/${{ github.event.pull_request.base.ref }}:SECURITY.md" > base_SECURITY.md 2>/dev/null || echo "" > base_SECURITY.md

            if cmp -s "SECURITY.md" "base_SECURITY.md"; then
              echo "‚ùå SECURITY.md not updated."
              echo "::warning::SECURITY.md not updated."
              exit 1
          fi

      - name: Final status
        run: echo "üéâ All lint checks passed successfully!"
